- hosts: all
  become: true
  vars:
        ova_path: '/var/provision/wazuh-virtual-machines'
        wia_scripts: 'wazuh-installation-assistant'
        wia_repository: 'https://github.com/wazuh/wazuh-installation-assistant/'
        packages_to_uninstall:
          - ec2-instance-connect
          - amazon-ssm-agent
          - ec2-hibinit-agent
          - ec2-net-utils
          - ec2-utils
          - ec2-instance-connect
          - aws-cfn-bootstrap
          - ucpid
          - amazon-linux-extras-yum-plugin
          - dracut-config-ec2
          - dracut-fips
          - ec2-instance-connect-selinux
          - grub2-efi-x64-ec2
          - grub2-tools-efi
          - grub2-tools-extra
          - hibagent
          - hmaccalc
        packages_to_install:
          - amazon-linux-onprem
          - apr
          - apr-util
          - cpp
          - gcc

  tasks:
    - name: Install git
      yum:
        name: git
        state: present

    - name: Make build directory
      file:
        path: "{{ ova_path }}"
        state: directory

    - name: Copy ova directory
      copy:
        src: "../../../ova"
        dest: "{{ ova_path }}"

    - name: Download the Wazuh installation assistant repository
      git:
        repo: "{{ wia_repository }}"
        version: "{{ wia_branch }}"
        dest: '/tmp/{{ wia_scripts }}'
        depth: 1
      register: clone_result
      retries: 6
      delay: 10
      until: clone_result is success

    - name: Set custom hostname
      command: "hostnamectl set-hostname wazuh-server"

    - name: Build Wazuh installation assistant script
      command: "bash /tmp/{{ wia_scripts }}/builder.sh {{ builder_args }}"

    - name: Copy Wazuh installation assistant script to tmp dir
      command: "cp /tmp/{{ wia_scripts }}/wazuh-install.sh /tmp/wazuh-install.sh"

    - name: Run provision script
      command: "bash provision.sh {{ repository }} {{ debug }}"
      args:
        chdir: "{{ ova_path }}/ova"
      async: 3600
      poll: 10

    - name: Install additional packages
      yum:
        name: "{{ item }}"
        state: present
      with_items: "{{ packages_to_install }}"

    - name: Remove unneeded packages
      yum:
        name: "{{ item }}"
        state: absent
      with_items: "{{ packages_to_uninstall }}"

    - name: Clean provision files
      file:
        path: /var/provision/
        state: absent

    - name: Clean Wazuh installation assistant resources
      file:
        path: /tmp/{{ wia_scripts }}
        state: absent

    - name: Clean Wazuh installation assistant script
      file:
        path: /tmp/wazuh-install.sh
        state: absent

    - name: Clean Wazuh installation assistant files
      file:
        path: /tmp/wazuh-install-files.tar
        state: absent

    - name: Clean logs
      shell: |
        find /var/log/ -type f -exec bash -c 'cat /dev/null > {}' \;
        find /var/ossec/logs -type f -execdir sh -c 'cat /dev/null > "$1"' _ {} \;
        find /var/log/wazuh-indexer -type f -execdir sh -c 'cat /dev/null > "$1"' _ {} \;
        find /var/log/filebeat -type f -execdir sh -c 'cat /dev/null > "$1"' _ {} \;
        rm -rf /var/log/wazuh-install.log

    - name: Clean history
      shell: cat /dev/null > ~/.bash_history && history -c

    - name: Clean YUM cache
      shell: |
        yum clean all
        rm -rf /var/cache/yum/*

    - name: Remove ec2-user
      user:
        name: ec2-user
        state: absent
        remove: yes
        force: yes

    - name: Remove ec2-user group
      group:
        name: ec2-user
        state: absent

    - name: Change ssh port to 22
      replace:
        path: /etc/ssh/sshd_config
        regexp: 'Port 2200'
        replace: '#Port 22'

    - name: Remove AuthorizedKeysCommand from sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AuthorizedKeysCommand.*'
        state: absent

    - name: Remove AuthorizedKeysCommandUser from sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AuthorizedKeysCommandUser.*'
        state: absent

    - name: Restart SSH service
      service:
        name: sshd
        state: restarted
