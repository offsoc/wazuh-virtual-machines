run-name: Wazuh AMI Test - Branch ${{ github.ref_name }} - Launched by @${{ github.actor }}
name: Wazuh AMI Test

on:
  workflow_dispatch:
    inputs:
      WAZUH_VIRTUAL_MACHINES_REFERENCE:
        description: 'Branch or tag of the wazuh-virtual-machines repository'
        required: true
        default: 'master'
      test_type:
        description: 'Test type (ami or ssh)'
        required: true
        default: 'ami'
        type: choice
        options:
          - ami
          - ssh
      host:
        description: 'AMI ID to create ami or host for direct ssh connection'
        required: false
        type: string
      key_name:
        description: 'Key name to use for SSH connection'
        required: false
        type: string
      WAZUH_SERVER_VERSION_REVISION:
        description: 'Expected Wazuh server version-revision'
        required: false
        type: string
      WAZUH_INDEXER_VERSION_REVISION:
        description: 'Expected Wazuh indexer version-revision'
        required: false
        type: string
      WAZUH_DASHBOARD_VERSION_REVISION:
        description: 'Expected Wazuh dashboard version-revision'
        required: false
        type: string
      TESTS:
        description: 'Test to run'
        required: false
        default: 'ALL'
        type: choice
        options:
          - ALL
          - CERTIFICATES
          - CONNECTIVITY
          - LOGS
          - SERVICE
          - VERSION
      log_level:
        description: 'Log level'
        required: false
        default: 'INFO'
        type: choice
        options:
          - INFO
          - DEBUG
          - TRACE

env:
  AWS_IAM_OVA_ROLE: ${{ secrets.AWS_IAM_OVA_ROLE }}
  WAZUH_SERVER_EXPECTED_VERSION: ${{ github.event.inputs.WAZUH_SERVER_VERSION_REVISION }}
  WAZUH_INDEXER_EXPECTED_VERSION: ${{ github.event.inputs.WAZUH_INDEXER_VERSION_REVISION }}
  WAZUH_DASHBOARD_EXPECTED_VERSION: ${{ github.event.inputs.WAZUH_DASHBOARD_VERSION_REVISION }}

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: View parameters
        run: echo "${{ toJson(inputs) }}"
      - name: Checkout wazuh/wazuh-virtual-machines repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.WAZUH_VIRTUAL_MACHINES_REFERENCE }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r wazuh_vm_tester/requirements.txt
          pip install -e wazuh_vm_tester/

      - name: Setup AWS role environment variables
        run: |
          echo "AWS_QA_AUTOMATION_ROLE=${{ secrets.AWS_QA_AUTOMATION_ROLE }}" >> $GITHUB_ENV
          echo "AWS_DEV_AUTOMATION_ROLE=${{ secrets.AWS_DEV_AUTOMATION_ROLE }}" >> $GITHUB_ENV
          echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "-----BEGIN RSA PRIVATE KEY-----
          MIIEpAIBAAKCAQEApSEmREcIGLWUbXvTRvXcpw0ZoJRWEoSZtLclhKVx1tThTU7W
          leupM0+FBrlPZGW2I+WmFa0DEGCtcPb6k1bHy6yKhwFhSWzthRYwxCy8oKw7QA0v
          0M6yVUuPPayveed1tLtZJsbeRW1D5Vjhzqenr9slYSS4K6tjYpyP4JRQgY+x/CNL
          wGb61f9ZQJIio79QnlpWQpmJVQxv7h/qJepdOtuyKUZ3WiZs5GFvbmYkPzLIFoAe
          tx+J42Bk0UeL5XdnN8WFzcoHrPs+78UaGLuPm6gpZAlp8yZkmhNzVeQZoJ00m558
          scnIHhv4zqQZD8QZRX7yCR594HwUkORusVl4dQIDAQABAoIBAHbBbF/WJcB/dgt2
          7e8uik2pYjDV/UC8FD6fKGBJC6HQ32dVt4WCQeEg4y5+vtYZP/B5DASytG1m2dVQ
          Cc1Er9OOduG44FqJ+Beqac/rzIxQ0RuzYBvvStmEybM1Kc2l5ETiJ693fgq4Fggu
          79ZLRJF4LV27pqfhTkxxBBgjEfLaWHWXRi+cgcDhbNU2KG0PBJvljqwpMTvV6wuT
          IhWAeyIJQY/pehHiaihBTIqsm87elKBWNT4GRB/5gbX9Jr8rIPv2DV9FlaeQX3SQ
          WaRXT2Og+H+bsOGv8tUwZpyzSTnAPIwy4L9SAUiYexI6E4jY5Z8JKlEXTxwOLVjj
          yjDUwNECgYEA2x1142tJyT8273v1gX4GVRVHL3NoIyiW4ca/UnrwlaQoRJDHbI5d
          U6R76jdDRxa7AFuNLBh5J6/ylcYGlyA7A29FxKJfF2BQZhvL8rJmCCRtPW5x8eSh
          37OGMprGFZaG8/pBJeWDzc5N1tBdmlKG72/EzNRyvD8yYLs/W921HQ8CgYEAwO08
          QjWCbjKWBVA639TtAf54tSwCEmRM2LA4CtXIvXjpgcBTXJlE+zWffhFN+hmozBpm
          C24HgoRv6DSl+qKB2QBGhT3TU/6uVBj0fhVmFgRnuHF+yQtoAvMtyfgt6K4y5ZhZ
          8dMD57MxbGQOdB72CkRdFajEWW8+1O27pu5T2jsCgYEAkOzsc24cEKrqF/5iRLLp
          V09KlRz9DPwkx9Kf6tr7084PAELOVIPZQKBzgVfp/NQQ/cyQFFFfmRtsFRo0c7LS
          tZPcjpFi2eBPbSoHfE/44nvNcSti3D5/vqlMIp5yVAcK3cZxXrJuuioxG9sXfiIF
          s8q2XVBLTy1xkb9nychbqYsCgYBL2vtebPujqHAkFq+PYoDtz8hWM798y8MLT/45
          BGWxWeE2CxC7z+e3fhX/0339YClmVtrYk6KQRtJZUpoQOeUkFV+k8/IrjG+u0UEQ
          cgl5jrHZa4aWNc3nmwXd657hZdzNOWHkGzvl1icQnyavsZy73LVc1sadA4iI4BBw
          SjTeEQKBgQCXqG3Lsoqny6Y+WNoRpV/EbDnPFhzNSQoHlT692KJ4UZG9UEzT+MxW
          Kd0FHbnNQsiBJvrapJYmkpZ0hFaljuebUe++sLIUyTT2EJlpbo8HNm5nF79kFjZG
          hXd5hxlsFtAL1yBIRSdkYnPquZP0uKQjZxqk2jU1PX4Fgtx7NPyLhg==
          -----END RSA PRIVATE KEY-----" > ~/.ssh/wazuh_test_key.pem
          chmod 400 ~/.ssh/wazuh_test_key.pem
          echo "SSH key created at ~/.ssh/wazuh_test_key.pem"

      - name: key
        run: |
          cat ~/.ssh/wazuh_test_key.pem

      - name: Run tests with AMI mode
        if: ${{ github.event.inputs.test_type == 'ami' }}
        run: |
          # Find the executable dynamically and store its path in a variable
          WAZUH_VM_TEST_PATH=$(find /opt/hostedtoolcache/Python -name "wazuh-vm-test" | head -n 1)

          # Exit if executable not found
          if [ -z "$WAZUH_VM_TEST_PATH" ]; then
            echo "Error: wazuh-vm-test executable not found"
            exit 1
          fi

          echo "Found executable at: $WAZUH_VM_TEST_PATH"

          # Run the tests using the dynamically found path
          $WAZUH_VM_TEST_PATH \
            --ami-id ${{ github.event.inputs.host }} \
            --test-pattern "${{ github.event.inputs.TESTS }}" \
            --log-level ${{ github.event.inputs.log_level || 'INFO' }} \
            --output github \
            --output-file test-results.github

      - name: Run tests with SSH mode
        if: ${{ github.event.inputs.test_type == 'ssh' }}
        run: |
          # Find the executable dynamically and store its path in a variable
          WAZUH_VM_TEST_PATH=$(find /opt/hostedtoolcache/Python -name "wazuh-vm-test" | head -n 1)

          # Exit if executable not found
          if [ -z "$WAZUH_VM_TEST_PATH" ]; then
            echo "Error: wazuh-vm-test executable not found"
            exit 1
          fi

          echo "Found executable at: $WAZUH_VM_TEST_PATH"

          # Run the tests using the dynamically found path
          $WAZUH_VM_TEST_PATH \
            --ssh-host ${{ github.event.inputs.host }} \
            --ssh-key-path ~/.ssh/wazuh_test_key.pem \
            --test-pattern "${{ github.event.inputs.TESTS }}" \
            --log-level ${{ github.event.inputs.log_level || 'INFO' }} \
            --output github \
            --output-file test-results.github

      - name: Parse test results
        if: always()
        id: parse-results
        run: |
          if [ -f test-results.github ]; then
            # Set environment variables from test results file
            while IFS= read -r line; do
              if [[ $line == *=* ]]; then
                echo $line >> $GITHUB_ENV
              fi
            done < test-results.github
          else
            echo "No test results file found!"
            echo "test_status=ERROR" >> $GITHUB_ENV
            echo "total_tests=0" >> $GITHUB_ENV
            echo "passed_tests=0" >> $GITHUB_ENV
            echo "failed_tests=0" >> $GITHUB_ENV
            echo "warning_tests=0" >> $GITHUB_ENV
            echo "skipped_tests=0" >> $GITHUB_ENV
            echo "short_summary=Failed to generate test results" >> $GITHUB_ENV
          fi

      - name: Create GitHub Summary
        if: always()
        run: |
          if [ -f test-results.github ]; then
            # Extract multiline summary from the test results
            awk '/summary<<EOF/{flag=1;next}/EOF/{flag=0}flag' test-results.github > summary.md
            cat summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## Test Execution Failed" >> $GITHUB_STEP_SUMMARY
            echo "No test results were generated. Please check the workflow logs." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set job status
        if: always()
        run: |
          if [[ "${{ env.test_status }}" == "PASS" ]]; then
            echo "Tests passed successfully!"
            exit 0
          elif [[ "${{ env.test_status }}" == "WARNING" ]]; then
            echo "Tests passed with warnings!"
            exit 0
          else
            echo "Tests failed with status: ${{ env.test_status }}"
            exit 1
          fi
